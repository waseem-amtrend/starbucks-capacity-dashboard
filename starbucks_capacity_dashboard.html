<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starbucks Vendor Direct Inventory - Amtrend Corporation</title>
    <link href="https://fonts.googleapis.com/css2?family=Gotham:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Amtrend Brand Colors */
            --amtrend-blue: #0072CE;
            --amtrend-grey-dark: #666666;
            --amtrend-grey-med: #999999;
            --amtrend-grey-light: #B3B3B3;
            --amtrend-grey-pale: #E6E6E6;
            /* Starbucks Brand Colors */
            --starbucks-green: #00704a;
            --starbucks-green-dark: #006241;
            --starbucks-dark: #1e3932;
        }

        body {
            font-family: 'Gotham', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #f7f7f7;
            color: var(--starbucks-dark);
        }

        /* Amtrend Top Bar */
        .amtrend-bar {
            background: linear-gradient(135deg, var(--amtrend-blue) 0%, #005fa3 100%);
            color: white;
            padding: 8px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
        }

        .amtrend-bar .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            letter-spacing: 2px;
        }

        .amtrend-bar .tagline {
            opacity: 0.9;
            font-weight: 300;
        }

        /* Amtrend Logo SVG */
        .amtrend-logo {
            height: 24px;
            width: auto;
        }

        .header {
            background: linear-gradient(135deg, var(--starbucks-green) 0%, var(--starbucks-green-dark) 100%);
            color: white;
            padding: 24px 40px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--starbucks-green);
            font-size: 24px;
        }

        .header-content {
            flex: 1;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.95;
            font-weight: 300;
        }

        .controls {
            padding: 20px 40px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            background: #00704a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #006241;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,112,74,0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn.loading {
            background: #006241;
        }

        .timestamp {
            margin-left: auto;
            color: #666;
            font-size: 13px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            background: #f0f0f0;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-dot.green { background: #28a745; }
        .status-dot.red { background: #dc3545; }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 40px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #00704a;
        }

        .summary-card.critical {
            border-left-color: #d62b1f;
            background: linear-gradient(135deg, #fff 0%, #fff5f5 100%);
        }

        .summary-card.warning {
            border-left-color: #f2a900;
            background: linear-gradient(135deg, #fff 0%, #fffef5 100%);
        }

        .summary-card h3 {
            font-size: 11px;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .summary-card .value {
            font-size: 42px;
            font-weight: 700;
            color: #1e3932;
            line-height: 1;
            margin-bottom: 8px;
        }

        .summary-card .label {
            font-size: 13px;
            color: #888;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1e3932;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #00704a;
            border-radius: 2px;
        }

        .sku-grid {
            display: grid;
            gap: 24px;
        }

        .sku-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .sku-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .sku-header {
            background: linear-gradient(135deg, #1e3932 0%, #2a5244 100%);
            color: white;
            padding: 24px;
        }

        .sku-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .starbucks-sku {
            font-size: 24px;
            font-weight: 700;
            color: white;
            background: rgba(255,255,255,0.2);
            padding: 6px 16px;
            border-radius: 8px;
            letter-spacing: 0.5px;
        }

        .amtrend-part {
            font-size: 18px;
            opacity: 0.95;
        }

        .sku-subtitle {
            font-size: 13px;
            opacity: 0.9;
        }

        .capacity-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        .capacity-box {
            padding: 16px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .capacity-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .capacity-number {
            font-size: 48px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 6px;
        }

        .capacity-number.blocked {
            color: #ff6b6b;
        }

        .limiting-component {
            font-size: 11px;
            opacity: 0.85;
        }

        .bom-table {
            width: 100%;
            border-collapse: collapse;
        }

        .bom-table th {
            background: #f7f7f7;
            padding: 12px 16px;
            text-align: left;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            border-bottom: 2px solid #e0e0e0;
        }

        .bom-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .bom-table tr:hover {
            background: #f9f9f9;
        }

        .component-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .component-type.frame { background: #d4e8ff; color: #0066cc; }
        .component-type.leather { background: #ffe4f0; color: #cc0066; }
        .component-type.pattern { background: #ffe9d4; color: #cc6600; }
        .component-type.foam { background: #d4f0e8; color: #00704a; }
        .component-type.packaging { background: #f0d4e8; color: #8800cc; }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .status-badge.ok { background: #d4edda; color: #155724; }
        .status-badge.critical { background: #f8d7da; color: #721c24; }
        .status-badge.warning { background: #fff3cd; color: #856404; }

        .po-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            background: #d4e8ff;
            color: #0066cc;
        }

        .po-details {
            font-size: 10px;
            color: #0066cc;
            margin-top: 4px;
            line-height: 1.4;
        }

        .inventory-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .inventory-table th {
            background: #f7f7f7;
            padding: 12px 16px;
            text-align: left;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            border-bottom: 2px solid #e0e0e0;
        }

        .inventory-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .inventory-table tr:hover {
            background: #f9f9f9;
        }

        .alert {
            background: #fff3cd;
            border-left: 4px solid #f2a900;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .alert-critical {
            background: #f8d7da;
            border-left-color: #d62b1f;
        }

        .alert-success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .alert h4 {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1e3932;
        }

        .alert p {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00704a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            font-size: 14px;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Amtrend Footer */
        .amtrend-footer {
            background: var(--starbucks-dark);
            color: white;
            padding: 30px 40px;
            margin-top: 40px;
        }

        .footer-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .footer-brand .logo-text {
            font-size: 18px;
            font-weight: 300;
            letter-spacing: 3px;
            color: var(--amtrend-blue);
        }

        .footer-info {
            font-size: 12px;
            opacity: 0.8;
            line-height: 1.6;
            font-weight: 300;
        }

        .footer-info strong {
            color: var(--amtrend-blue);
            font-weight: 500;
        }

        .footer-tech {
            font-size: 11px;
            opacity: 0.6;
            text-align: right;
        }

        .footer-tech a {
            color: var(--amtrend-blue);
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <div class="loading-text">Loading live data from Epicor...</div>
        </div>
    </div>

    <!-- Amtrend Top Bar -->
    <div class="amtrend-bar">
        <div class="brand">
            <svg class="amtrend-logo" viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg">
                <text x="0" y="35" fill="white" font-family="Gotham, Arial" font-size="24" font-weight="300" letter-spacing="3">AMTREND</text>
            </svg>
        </div>
        <div class="tagline">Vendor Direct Inventory Management System</div>
    </div>

    <div class="header">
        <div class="logo">&#9733;</div>
        <div class="header-content">
            <h1>Starbucks Vendor Direct Inventory Dashboard</h1>
            <p>Real-time production capacity analysis - Master Quote: 109209</p>
            <div style="margin-top: 12px; font-size: 12px; opacity: 0.9; font-weight: 300;">
                SKU Mapping: 11174933&#8594;SBX-22721 | 11174935&#8594;SBX-24545 | 11174936&#8594;SBX-24540 | 11174937&#8594;SBX-22880 | 11174939&#8594;SBX-24541
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn" onclick="refreshData()" id="refreshBtn">
            <span id="refreshIcon">&#8635;</span>
            <span id="refreshText">Refresh Data</span>
        </button>
        <div class="connection-status" id="connectionStatus">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Checking...</span>
        </div>
        <div class="timestamp" id="timestamp">Last updated: --</div>
    </div>

    <div class="container">
        <div class="error-message" id="errorMessage"></div>

        <div class="alert" id="skuRefAlert">
            <h4>&#128203; Starbucks SKU Reference</h4>
            <p><strong>SKU: 11174933</strong> &#8594; Amtrend Part: SBX-22721 (Moon Chair, Fern Green)<br>
               <strong>SKU: 11174935</strong> &#8594; Amtrend Part: SBX-24545 (Moon Chair, Roast Natural)<br>
               <strong>SKU: 11174936</strong> &#8594; Amtrend Part: SBX-24540 (Comf Chair, Fern Green)<br>
               <strong>SKU: 11174937</strong> &#8594; Amtrend Part: SBX-22880 (Comf Chair, Tan Brown)<br>
               <strong>SKU: 11174939</strong> &#8594; Amtrend Part: SBX-24541 (Comf Chair, Roast Natural)</p>
        </div>

        <div class="alert alert-critical" id="criticalAlert" style="display: none;">
            <h4>&#9888;&#65039; CRITICAL: Production Status</h4>
            <p id="criticalAlertText"></p>
        </div>

        <div class="summary-grid" id="summaryGrid">
            <!-- Summary cards populated by JS -->
        </div>

        <div class="section">
            <div class="inventory-section">
                <h2 class="section-title">Raw Material Inventory</h2>
                <table class="inventory-table" id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Part Number</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>On Hand</th>
                            <th>Committed</th>
                            <th>True Avail</th>
                            <th>Incoming</th>
                            <th>Future</th>
                            <th>UOM</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody">
                        <!-- Rows populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Production Capacity by SKU</h2>
            <div class="sku-grid" id="skuGrid">
                <!-- SKU cards populated by JS -->
            </div>
        </div>
    </div>

    <script>
        // API Base URL - use relative URLs for same-origin requests
        const API_BASE = '';

        // Global data store
        let capacityData = null;
        let lastUpdate = null;

        // Format numbers with commas
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return num.toLocaleString('en-US', { maximumFractionDigits: 2 });
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } catch {
                return dateStr;
            }
        }

        // Get status class
        function getStatusClass(status) {
            if (status === 'critical') return 'critical';
            if (status === 'warning') return 'warning';
            return 'ok';
        }

        // Get status badge HTML
        function getStatusBadge(available, maxUnits) {
            if (available <= 0) {
                return '<span class="status-badge critical">&#10007; ZERO</span>';
            } else if (maxUnits < 10) {
                return '<span class="status-badge warning">&#9888; LOW</span>';
            }
            return '<span class="status-badge ok">&#10003; OK</span>';
        }

        // Show/hide loading overlay
        function setLoading(loading) {
            const overlay = document.getElementById('loadingOverlay');
            const btn = document.getElementById('refreshBtn');
            const text = document.getElementById('refreshText');

            if (loading) {
                overlay.classList.remove('hidden');
                btn.disabled = true;
                btn.classList.add('loading');
                text.textContent = 'Loading...';
            } else {
                overlay.classList.add('hidden');
                btn.disabled = false;
                btn.classList.remove('loading');
                text.textContent = 'Refresh Data';
            }
        }

        // Show error message
        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.classList.add('show');
        }

        // Hide error message
        function hideError() {
            document.getElementById('errorMessage').classList.remove('show');
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');

            if (connected) {
                status.className = 'connection-status connected';
                dot.className = 'status-dot green';
                text.textContent = 'Epicor Connected';
            } else {
                status.className = 'connection-status disconnected';
                dot.className = 'status-dot red';
                text.textContent = 'Disconnected';
            }
        }

        // Render summary cards
        function renderSummary(summary, data) {
            const grid = document.getElementById('summaryGrid');

            // Count critical items
            let criticalComponents = 0;
            Object.values(data).forEach(sku => {
                sku.bottlenecks.forEach(b => {
                    if (b.status === 'critical') criticalComponents++;
                });
            });

            grid.innerHTML = `
                <div class="summary-card ${summary.totalCurrentCapacity === 0 ? 'critical' : ''}">
                    <h3>Current Capacity</h3>
                    <div class="value">${formatNumber(summary.totalCurrentCapacity)}</div>
                    <div class="label">units ready now</div>
                </div>
                <div class="summary-card">
                    <h3>Future Capacity</h3>
                    <div class="value">${formatNumber(summary.totalFutureCapacity)}</div>
                    <div class="label">with incoming POs</div>
                </div>
                <div class="summary-card ${summary.blockedSkus > 0 ? 'critical' : ''}">
                    <h3>Blocked SKUs</h3>
                    <div class="value">${summary.blockedSkus}</div>
                    <div class="label">out of ${summary.totalSkus} total</div>
                </div>
                <div class="summary-card warning">
                    <h3>Critical Components</h3>
                    <div class="value">${criticalComponents}</div>
                    <div class="label">need attention</div>
                </div>
                <div class="summary-card">
                    <h3>Master Quote</h3>
                    <div class="value">109209</div>
                    <div class="label">reference</div>
                </div>
            `;

            // Update critical alert
            const alert = document.getElementById('criticalAlert');
            const alertText = document.getElementById('criticalAlertText');

            if (summary.blockedSkus > 0) {
                // Find blocking components
                const blockingParts = new Set();
                Object.values(data).forEach(sku => {
                    if (sku.isBlocked) {
                        sku.bottlenecks.forEach(b => {
                            if (b.available <= 0) blockingParts.add(b.component);
                        });
                    }
                });

                alert.style.display = 'block';
                alertText.textContent = `${summary.blockedSkus} out of ${summary.totalSkus} SKUs are blocked due to zero inventory on: ${Array.from(blockingParts).join(', ')}`;
            } else {
                alert.style.display = 'none';
            }
        }

        // Render SKU cards - simplified view without PO details
        function renderSkuCards(data) {
            const grid = document.getElementById('skuGrid');
            grid.innerHTML = '';

            // Sort SKUs by Starbucks part number
            const sortedSkus = Object.entries(data).sort((a, b) =>
                a[1].starbucksPartNum.localeCompare(b[1].starbucksPartNum)
            );

            sortedSkus.forEach(([sku, skuData]) => {
                const card = document.createElement('div');
                card.className = 'sku-card';

                const isBlocked = skuData.maxProductionNow === 0;

                // Build simplified BOM rows with committed qty
                let bomRows = '';
                skuData.bottlenecks.forEach(b => {
                    const incomingHtml = b.incomingQty > 0
                        ? `<span class="po-badge">+${formatNumber(b.incomingQty)}</span>`
                        : '-';

                    // Show committed qty (job demand)
                    const jobDemand = b.jobDemand || 0;
                    const committedHtml = jobDemand > 0
                        ? `<span class="status-badge warning">${formatNumber(jobDemand)}</span>`
                        : '-';

                    // Use trueAvailable
                    const trueAvailable = b.trueAvailable !== undefined ? b.trueAvailable : b.available;

                    bomRows += `
                        <tr>
                            <td><strong>${b.component}</strong></td>
                            <td><span class="component-type ${b.type.toLowerCase()}">${b.type}</span></td>
                            <td>${formatNumber(b.qtyPer)} ${b.uom}</td>
                            <td>${committedHtml}</td>
                            <td><strong>${formatNumber(trueAvailable)}</strong></td>
                            <td>${incomingHtml}</td>
                            <td><strong>${formatNumber(b.futureAvailable)}</strong></td>
                            <td>${getStatusBadge(trueAvailable, b.maxUnitsNow)}</td>
                        </tr>
                    `;
                });

                card.innerHTML = `
                    <div class="sku-header">
                        <div class="sku-title">
                            <span class="starbucks-sku">SKU: ${skuData.starbucksPartNum}</span>
                            <span class="amtrend-part">&#8594; ${sku}</span>
                        </div>
                        <div class="sku-subtitle">${skuData.description}</div>

                        <div class="capacity-grid">
                            <div class="capacity-box">
                                <div class="capacity-label">Current Capacity</div>
                                <div class="capacity-number ${isBlocked ? 'blocked' : ''}">${skuData.maxProductionNow}</div>
                                <div class="limiting-component">${isBlocked ? 'BLOCKED by ' : 'Limited by '} ${skuData.limitingComponentNow}</div>
                            </div>
                            <div class="capacity-box">
                                <div class="capacity-label">Future Capacity</div>
                                <div class="capacity-number">${skuData.maxProductionFuture}</div>
                                <div class="limiting-component">With incoming POs</div>
                            </div>
                        </div>
                    </div>

                    <table class="bom-table">
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>Type</th>
                                <th>Qty/Unit</th>
                                <th>Committed</th>
                                <th>True Avail</th>
                                <th>Incoming</th>
                                <th>Future</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bomRows}
                        </tbody>
                    </table>
                `;

                grid.appendChild(card);
            });
        }

        // Render inventory table
        function renderInventoryTable(data) {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';

            // Collect all unique components from all SKUs
            const components = {};
            Object.values(data).forEach(sku => {
                sku.bottlenecks.forEach(b => {
                    if (!components[b.component]) {
                        components[b.component] = b;
                    }
                });
            });

            // Sort by part number
            const sortedComponents = Object.values(components).sort((a, b) =>
                a.component.localeCompare(b.component)
            );

            sortedComponents.forEach(comp => {
                const incomingHtml = comp.incomingQty > 0
                    ? `<span class="po-badge">+${formatNumber(comp.incomingQty)}</span>`
                    : '-';

                // Show committed qty (job demand) with job count
                const jobDemand = comp.jobDemand || 0;
                const jobCount = comp.jobCount || 0;
                const committedHtml = jobDemand > 0
                    ? `<span class="status-badge warning">${formatNumber(jobDemand)} (${jobCount} job${jobCount !== 1 ? 's' : ''})</span>`
                    : '-';

                // Use trueAvailable for the available column
                const trueAvailable = comp.trueAvailable !== undefined ? comp.trueAvailable : comp.available;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${comp.component}</strong></td>
                    <td>${comp.description || '-'}</td>
                    <td><span class="component-type ${comp.type.toLowerCase()}">${comp.type}</span></td>
                    <td>${formatNumber(comp.onHand)}</td>
                    <td>${committedHtml}</td>
                    <td><strong>${formatNumber(trueAvailable)}</strong></td>
                    <td>${incomingHtml}</td>
                    <td><strong>${formatNumber(comp.futureAvailable)}</strong></td>
                    <td>${comp.uom}</td>
                    <td>${getStatusBadge(trueAvailable, comp.maxUnitsNow)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Fetch capacity data from API
        async function fetchCapacityData() {
            const response = await fetch(`${API_BASE}/api/capacity`);
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            return response.json();
        }

        // Check health endpoint
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                updateConnectionStatus(data.epicor?.connected || false);
                return data.epicor?.connected || false;
            } catch (e) {
                updateConnectionStatus(false);
                return false;
            }
        }

        // Main refresh function
        async function refreshData() {
            setLoading(true);
            hideError();

            try {
                const result = await fetchCapacityData();

                if (result.success) {
                    capacityData = result.data;
                    lastUpdate = result.timestamp;

                    // Update timestamp
                    const date = new Date(lastUpdate);
                    document.getElementById('timestamp').textContent =
                        `Last updated: ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;

                    // Render all sections
                    renderSummary(result.summary, result.data);
                    renderSkuCards(result.data);
                    renderInventoryTable(result.data);

                    updateConnectionStatus(true);
                } else {
                    throw new Error(result.error || 'Failed to fetch data');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                showError(`Failed to load data: ${error.message}. Please check your connection and try again.`);
                updateConnectionStatus(false);
            } finally {
                setLoading(false);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check health first
            checkHealth();

            // Load initial data
            refreshData();

            // Auto-refresh disabled - user can refresh manually via button
        });
    </script>

    <!-- Amtrend Footer -->
    <footer class="amtrend-footer">
        <div class="footer-content">
            <div class="footer-brand">
                <svg viewBox="0 0 231 35" width="150" height="23" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#006CAD" d="M16.748,1.542l8.34,19.676H8.453L16.748,1.542z M15.873,0.251L1.772,33.107H0.251v1.244h2.488l5.115-11.889h17.833l5.116,11.889h2.488v-1.244h-1.567L17.669,0.251H15.873z"/>
                    <polygon fill="#006CAD" points="73.243,0.251 57.528,32.14 41.77,0.251 38.313,0.251 38.313,1.495 39.558,1.495 39.558,33.107 38.313,33.107 38.313,34.351 42.184,34.351 42.184,33.107 40.939,33.107 40.939,1.633 57.114,34.351 57.897,34.351 74.025,1.633 74.025,33.107 72.781,33.107 72.781,34.351 76.652,34.351 76.652,33.107 75.409,33.107 75.409,1.495 76.652,1.495 76.652,0.251"/>
                    <polygon fill="#006CAD" points="81.767,0.251 81.767,2.739 83.01,2.739 83.01,1.495 91.028,1.495 91.028,33.107 89.784,33.107 89.784,34.351 93.655,34.351 93.655,33.107 92.41,33.107 92.41,1.495 100.428,1.495 100.428,2.739 101.673,2.739 101.673,0.251"/>
                    <path fill="#006CAD" d="M116.28,20.25h0.968c2.488,0,6.543,0,8.709-2.166c2.166-2.258,2.903-4.608,2.903-7.281c0-2.949-1.428-6.221-4.055-7.926c-2.074-1.336-4.563-1.383-8.571-1.383h-6.406v32.856h-2.626v-1.244h1.244V1.495h-1.244V0.25h9.032c5.299,0,7.419,0.461,9.078,1.429c2.765,1.383,4.931,5.115,4.931,9.078c0.092,2.12-0.553,4.792-2.166,6.912c-2.488,3.271-5.346,3.687-9.216,3.825l8.248,11.612h2.166v1.244h-2.995L116.28,20.25z"/>
                    <polygon fill="#006CAD" points="155.356,17.808 139.273,17.808 139.273,33.107 155.356,33.107 155.356,31.863 156.6,31.863 156.6,34.351 136.647,34.351 136.647,33.107 137.891,33.107 137.891,1.495 136.647,1.495 136.647,0.25 156.6,0.25 156.6,2.739 155.356,2.739 155.356,1.495 139.273,1.495 139.273,16.564 155.356,16.564 155.356,15.32 156.6,15.32 156.6,19.052 155.356,19.052"/>
                    <polygon fill="#006CAD" points="165.308,0.25 168.625,0.25 192.082,32.508 192.082,0.25 194.708,0.25 194.708,1.495 193.463,1.495 193.463,34.351 191.713,34.351 167.934,1.633 167.934,33.107 169.178,33.107 169.178,34.351 165.308,34.351 165.308,33.107 166.552,33.107 166.552,1.495 165.308,1.495"/>
                    <path fill="#006CAD" d="M202.77,33.107h1.244V1.495h-1.244V0.251h10.875c5.393,0,9.678,1.567,12.627,4.516c2.949,2.903,4.563,7.143,4.563,12.534c0,10.737-6.451,17.05-17.189,17.05H202.77V33.107z M205.397,33.107h8.248c9.862,0,15.807-5.853,15.807-15.714c0-4.976-1.429-8.939-4.147-11.705c-2.719-2.719-6.636-4.193-11.659-4.193h-8.248V33.107z"/>
                </svg>
            </div>
            <div class="footer-info">
                <strong>Amtrend Corporation</strong><br>
                1458 Manhattan Ave, Fullerton, CA 92831<br>
                Contract Furniture Manufacturing - Made in California
            </div>
            <div class="footer-tech">
                Powered by <strong>Epicor Kinetic ERP</strong><br>
                Real-time inventory via REST API<br>
                <a href="/health">System Status</a>
            </div>
        </div>
    </footer>
</body>
</html>
